<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.0.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <style>
      #menu {
        position: fixed;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.7);
        padding: 10px 20px;
        border-radius: 15px;
        color: white;
        font-family: sans-serif;
        z-index: 999;
        text-align: center;
        width: 80%;
        max-width: 400px;
        display: none;
      }

      #menu button {
        margin: 5px;
        padding: 8px 15px;
        border: none;
        border-radius: 10px;
        background: #1e90ff;
        color: white;
        font-weight: bold;
        cursor: pointer;
      }

      #menu button:hover {
        background: #4682b4;
      }

      #fact-box {
        margin-top: 10px;
        font-size: 14px;
      }

      /* Mensaje de búsqueda */
      #scan-message {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: rgba(0, 0, 0, 0.75);
        padding: 12px 18px;
        border-radius: 12px;
        color: white;
        font-family: sans-serif;
        z-index: 1000;
        text-align: center;
      }

      #scan-message img {
        display: block;
        margin: 10px auto 0 auto;
        max-width: 150px;
        border-radius: 8px;
      }

      /* Botones de control */
      #controls {
        position: fixed;
        bottom: 90px;
        left: 50%;
        transform: translateX(-50%);
        z-index: 1000;
        display: flex;
        gap: 10px;
      }

      #controls button {
        padding: 6px 12px;
        border: none;
        border-radius: 8px;
        background: #444;
        color: white;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <!-- MENSAJE ESCANEAR -->
    <div id="scan-message">
      Apunta tu cámara hacia las imágenes para comenzar
      <img id="scan-image" src="./target1.png" alt="Target a escanear">
    </div>

    <!-- Menú flotante -->
    <div id="menu">
      <div id="fact-box">Selecciona un animal para ver curiosidades</div>
      <div>
        <button id="btnPrev">⬅️ Anterior</button>
        <button id="btnNext">➡️ Siguiente</button>
      </div>
    </div>

    <!-- Controles AR -->
    <div id="controls">
      <button id="btnStart">▶️ Start</button>
      <button id="btnPause">⏸ Pause</button>
      <button id="btnStop">⏹ Stop</button>
    </div>

    <!-- Escena AR -->
    <a-scene
      mindar-image="imageTargetSrc: ./targets.mind; maxTrack: 2"
      color-space="sRGB"
      renderer="colorManagement: true, physicallyCorrectLights"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
    >
      <a-assets>
        <a-asset-item id="WhaleModel" src="./WhaleO1.glb"></a-asset-item>
        <a-asset-item id="OctopusModel" src="./Octopus.glb"></a-asset-item>
      </a-assets>

      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- Ballena -->
      <a-entity id="target-whale" mindar-image-target="targetIndex: 0">
        <a-gltf-model
          id="whale-model"
          src="#WhaleModel"
          position="0 0 0"
          scale="0.7 0.7 0.7"
          rotation="0 0 0"
          animation__updown="property: position; to: 0 0.3 0; dur: 2000; easing: easeInOutSine; loop: true; dir: alternate"
          animation__spin="property: rotation; to: 0 360 0; dur: 6000; loop: true; easing: linear"
        ></a-gltf-model>
      </a-entity>

      <!-- Pulpo -->
      <a-entity id="target-octopus" mindar-image-target="targetIndex: 1">
        <a-gltf-model
          id="octopus-model"
          src="#OctopusModel"
          position="0 -0.25 0"
          scale="0.05 0.05 0.05"
          rotation="0 0 0"
          animation__updown="property: position; to: 0 0.2 0; dur: 2500; easing: easeInOutSine; loop: true; dir: alternate"
          animation__spin="property: rotation; to: 0 360 0; dur: 8000; loop: true; easing: linear"
        ></a-gltf-model>
      </a-entity>
    </a-scene>

    <script>
      const factBox = document.querySelector("#fact-box");
      const menu = document.querySelector("#menu");
      const scanMessage = document.querySelector("#scan-message");

      const facts = {
        whale: [
          "Las ballenas azules son los animales más grandes que han existido.",
          "Su corazón puede pesar lo mismo que un coche pequeño.",
          "Se comunican con cantos que viajan grandes distancias bajo el agua."
        ],
        octopus: [
          "Los pulpos tienen tres corazones y sangre azul.",
          "Pueden cambiar de color y textura para camuflarse.",
          "Son considerados de los invertebrados más inteligentes."
        ]
      };

      let currentAnimal = null;
      let factIndex = 0;
      let whaleDetected = false;
      let octopusDetected = false;

      function showFact() {
        if (currentAnimal) {
          factBox.innerText = facts[currentAnimal][factIndex];
        }
      }

      function updateMenuVisibility() {
        if ((whaleDetected && !octopusDetected) || (!whaleDetected && octopusDetected)) {
          menu.style.display = "block";
          scanMessage.style.display = "none";
        } else {
          menu.style.display = "none";
          if (!whaleDetected && !octopusDetected) {
            scanMessage.style.display = "block";
          }
        }
      }

      // Eventos detección ballena
      document.getElementById("target-whale").addEventListener("targetFound", () => {
        console.log("Ballena detectada");
        whaleDetected = true;
        if (!octopusDetected) {
          currentAnimal = "whale";
          factIndex = 0;
          showFact();
        }
        updateMenuVisibility();
      });
      document.getElementById("target-whale").addEventListener("targetLost", () => {
        console.log("Ballena perdida");
        whaleDetected = false;
        updateMenuVisibility();
      });

      // Eventos detección pulpo
      document.getElementById("target-octopus").addEventListener("targetFound", () => {
        console.log("Pulpo detectado");
        octopusDetected = true;
        if (!whaleDetected) {
          currentAnimal = "octopus";
          factIndex = 0;
          showFact();
        }
        updateMenuVisibility();
      });
      document.getElementById("target-octopus").addEventListener("targetLost", () => {
        console.log("Pulpo perdido");
        octopusDetected = false;
        updateMenuVisibility();
      });

      // Botones curiosidades
      document.querySelector("#btnNext").addEventListener("click", () => {
        if (currentAnimal) {
          factIndex = (factIndex + 1) % facts[currentAnimal].length;
          showFact();
        }
      });
      document.querySelector("#btnPrev").addEventListener("click", () => {
        if (currentAnimal) {
          factIndex = (factIndex - 1 + facts[currentAnimal].length) % facts[currentAnimal].length;
          showFact();
        }
      });

      // -------- NUEVO: Rotación de imágenes en el mensaje --------
      const scanImage = document.querySelector("#scan-image");
      const scanImages = ["./Ballena3.png", "./OctupusO3.png"];
      let scanIndex = 0;
      setInterval(() => {
        scanIndex = (scanIndex + 1) % scanImages.length;
        scanImage.src = scanImages[scanIndex];
      }, 2000);

      // -------- NUEVO: Eventos A-FRAME globales --------
      const sceneEl = document.querySelector("a-scene");
      let arSystem;

      sceneEl.addEventListener("loaded", () => {
        arSystem = sceneEl.systems["mindar-image-system"];
      });

      sceneEl.addEventListener("arReady", () => {
        console.log("AR está listo ✅");
      });

      sceneEl.addEventListener("arError", (err) => {
        console.error("Error en AR ❌", err);
      });

      // Controles Start / Pause / Stop
      document.querySelector("#btnStart").addEventListener("click", () => {
        console.log("▶️ Iniciando AR");
        arSystem.start();
      });
      document.querySelector("#btnPause").addEventListener("click", () => {
        console.log("⏸ Pausando AR");
        arSystem.pause();
      });
      document.querySelector("#btnStop").addEventListener("click", () => {
        console.log("⏹ Deteniendo AR");
        arSystem.stop();
      });
    </script>
  </body>
</html>


